package main

import (
	_ "embed"
	"log"
	"os"
	"strings"

	"go.opentelemetry.io/collector/component"
	"go.opentelemetry.io/collector/confmap"
	"go.opentelemetry.io/collector/confmap/provider/envprovider"
	"go.opentelemetry.io/collector/confmap/provider/fileprovider"
	"go.opentelemetry.io/collector/confmap/provider/httpprovider"
	"go.opentelemetry.io/collector/confmap/provider/httpsprovider"
	"go.opentelemetry.io/collector/confmap/provider/yamlprovider"
	"go.opentelemetry.io/collector/otelcol"
)

//go:embed default_config.yaml
var defaultConfigFile []byte

func getEnv(key, fallback string) string {
	if v, ok := os.LookupEnv(key); ok && v != "" {
		return v
	}
	return fallback
}

func main() {
	// 1. Check command-line arguments
	useDefault := true
	for _, arg := range os.Args {
		if arg == "--config" || arg == "-c" {
			useDefault = false
			break
		}
	}

	// 2. Use the settings based on components.go generated by OCB
	info := component.BuildInfo{
		Command:     "span-report-collector",
		Description: "custom OpenTelemetry Collector",
		Version:     "1.0.0",
	}

	set := otelcol.CollectorSettings{
		BuildInfo: info,
		Factories: components,
		ConfigProviderSettings: otelcol.ConfigProviderSettings{
			ResolverSettings: confmap.ResolverSettings{
				ProviderFactories: []confmap.ProviderFactory{
					envprovider.NewFactory(),
					fileprovider.NewFactory(),
					httpprovider.NewFactory(),
					httpsprovider.NewFactory(),
					yamlprovider.NewFactory(),
				},
			},
		},
		ProviderModules: map[string]string{
			envprovider.NewFactory().Create(confmap.ProviderSettings{}).Scheme():   "go.opentelemetry.io/collector/confmap/provider/envprovider v1.48.0",
			fileprovider.NewFactory().Create(confmap.ProviderSettings{}).Scheme():  "go.opentelemetry.io/collector/confmap/provider/fileprovider v1.48.0",
			httpprovider.NewFactory().Create(confmap.ProviderSettings{}).Scheme():  "go.opentelemetry.io/collector/confmap/provider/httpprovider v1.48.0",
			httpsprovider.NewFactory().Create(confmap.ProviderSettings{}).Scheme(): "go.opentelemetry.io/collector/confmap/provider/httpsprovider v1.48.0",
			yamlprovider.NewFactory().Create(confmap.ProviderSettings{}).Scheme():  "go.opentelemetry.io/collector/confmap/provider/yamlprovider v1.48.0",
		},
		ConverterModules: []string{},
	}

	// 3. Inject default configuration
	if useDefault {
		// 1. Load embedded file content
		rawYaml := string(defaultConfigFile)

		// 2. Prepare replacement data
		replacer := strings.NewReplacer(
			"{{OTLP_ENDPOINT_GRPC}}", getEnv("SPAN_REPORT_OTLP_ENDPOINT_GRPC", "localhost:4317"),
			"{{OTLP_ENDPOINT_HTTP}}", getEnv("SPAN_REPORT_OTLP_ENDPOINT_HTTP", "localhost:4318"),
			"{{TUI_ENABLED}}", getEnv("SPAN_REPORT_TUI", "false"),
			"{{REPORT_PATH}}", getEnv("SPAN_REPORT_PATH", "./span_report.txt"),
			"{{REPORT_INTERVAL}}", getEnv("SPAN_REPORT_INTERVAL", "1h"),
			"{{VERBOSE_LOGGING}}", getEnv("SPAN_REPORT_VERBOSE", "false"),
		)

		// 3. Perform all replacements
		finalYaml := replacer.Replace(rawYaml)

		// 4. Write out as a temporary file
		tmpFile, err := os.CreateTemp("", "otel_config_*.yaml")
		if err != nil {
			log.Fatalf("failed to create temp file: %v", err)
		}
		defer os.Remove(tmpFile.Name())

		if _, err := tmpFile.WriteString(finalYaml); err != nil {
			log.Fatalf("failed to write to temp file: %v", err)
		}
		tmpFile.Close()

		// 5. Tell the Collector the path of the temporary file
		set.ConfigProviderSettings.ResolverSettings.URIs = []string{tmpFile.Name()}
	}
	// 4. Execute (use NewCommand compatible with both Windows and Linux)
	cmd := otelcol.NewCommand(set)
	if err := cmd.Execute(); err != nil {
		log.Fatalf("failed to execute command: %v", err)
	}
}
